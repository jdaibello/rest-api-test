name: Deploy Infrastructure

on:
  push:
    branches:
      - feature/*
      - current
      - develop
      - qa
      - uat
      - main

jobs:
  setup:
    name: Setup Environment
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set Environment Variables
        id: set-vars

        run: |
          COMMIT_HASH_SHORT=$(git rev-parse --short HEAD)
          echo "COMMIT_HASH_SHORT=${COMMIT_HASH_SHORT}" >> .env

          case "${GITHUB_REF#refs/heads/}" in
            feature/*)
              KUSTOMIZE_PATH=terraform/k8s/overlays/sandbox
              TAG=sandbox
              ;;
            current)
              KUSTOMIZE_PATH=terraform/k8s/overlays/sandbox
              TAG=sandbox
              ;;
            develop)
              KUSTOMIZE_PATH=terraform/k8s/overlays/dev
              TAG=dev
              ;;
            qa)
              KUSTOMIZE_PATH=terraform/k8s/overlays/qa
              TAG=qa
              ;;
            uat)
              KUSTOMIZE_PATH=terraform/k8s/overlays/uat
              TAG=uat
              ;;
            main)
              KUSTOMIZE_PATH=terraform/k8s/overlays/prod
              TAG=latest
              ;;
          esac

          echo "KUSTOMIZE_PATH=${KUSTOMIZE_PATH}" >> .env
          echo "DOCKER_IMAGE_TAG=${TAG}" >> .env

      - name: Upload .env file
        uses: actions/upload-artifact@v3
        with:
          name: env-file
          path: .env

      - name: Log envs
        run: |
          source .env

          echo "COMMIT_HASH_SHORT=$COMMIT_HASH_SHORT"
          echo "KUSTOMIZE_PATH=$KUSTOMIZE_PATH"
          echo "DOCKER_IMAGE_TAG=$DOCKER_IMAGE_TAG"

  docker:
    name: Build and Push Docker Image
    runs-on: self-hosted
    needs: setup

    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      PLATFORMS: linux/amd64,linux/arm64

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download .env file
        uses: actions/download-artifact@v3
        with:
          name: env-file
          path: .

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PAT }}" | docker login docker.io -u "$DOCKER_USERNAME" --password-stdin

      - name: Build and push Docker image

        env:
          COMMIT_HASH_SHORT: ${{ env.COMMIT_HASH_SHORT }}
          DOCKER_IMAGE_TAG: ${{ env.DOCKER_IMAGE_TAG }}

        run: |
          source .env

          echo "COMMIT_HASH_SHORT=${COMMIT_HASH_SHORT}"
          echo "DOCKER_IMAGE_TAG=${DOCKER_IMAGE_TAG}"

          docker buildx build --platform $PLATFORMS -f Dockerfile -t docker.io/$DOCKER_USERNAME/rest-api-test:${COMMIT_HASH_SHORT} -t docker.io/$DOCKER_USERNAME/rest-api-test:${DOCKER_IMAGE_TAG} --push .

  terraform:
    name: Deploy Terraform Infrastructure
    runs-on: self-hosted
    needs: [setup, docker]

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      KUBECONFIG: ${{ secrets.KUBECONFIG_CONTENT }}
      TERRAFORM_DIR: terraform

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Download .env from artifacts
        uses: actions/download-artifact@v3
        with:
          name: env-file
          path: .

      - name: Install Kind using Homebrew
        run: brew install kind

      # - name: Create a local Kubernetes cluster
      #  run: kind create cluster --name rest-api-test-local-cluster --image kindest/node:v1.21.1

      - name: Get kubeconfig
        run: kind get kubeconfig --name rest-api-test-local-cluster > ${{ runner.workspace }}/terraform/k8s/.kube

      - name: Set permissions for kubeconfig
        run: chmod 600 ${{ runner.workspace }}/terraform/k8s/.kube/config.yaml

      - name: Display kubeconfig content
        run: cat ${{ runner.workspace }}/terraform/k8s/.kube/config.yaml

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

      - name: Replace image tag in deployment YAML
        run: |
          source .env

          sed -i "s|docker.io/jpdev99/rest-api-test:sandbox|docker.io/jpdev99/rest-api-test:${COMMIT_HASH_SHORT}|g" ${{ runner.workspace }}/terraform/k8s/base/deployment.yaml

      - name: Replace namespace in all k8s manifests
        run: |
          source .env

          for file in ${{ runner.workspace }}/terraform/k8s/base/*.yaml; do
            sed -i "s|namespace: rest-api-test-sandbox-ns|namespace: rest-api-test-${DOCKER_IMAGE_TAG}-ns|g" "$file"
          done

      - name: Replace paths in Terraform cluster file
        run: |
          sed -i 's|\${{ runner.workspace }}/k8s|\${{ runner.workspace }}/../k8s|g' ${{ runner.workspace }}/terraform/cluster/main.tf

      - name: Update Terraform paths in other files
        run: |
          find . -type f -name "*.tf" -exec sed -i 's|\${{ runner.workspace }}/k8s|\${{ runner.workspace }}/terraform/k8s|g' {} +

      - name: Terraform Init
        run: terraform -chdir=$TERRAFORM_DIR init -input=false -reconfigure

      - name: Terraform Validate
        run: terraform -chdir=$TERRAFORM_DIR validate

      - name: Terraform Plan
        run: |
          source .env
          mkdir -p ${{ runner.workspace }}/terraform/tfvars
          touch ${{ runner.workspace }}/terraform/tfvars/.env.terraform

          cat <<EOF > ${{ runner.workspace }}/terraform/tfvars/.env.terraform
          dockerhub_email = "${{ secrets.DOCKER_EMAIL }}"
          dockerhub_username = "${{ secrets.DOCKER_USERNAME }}"
          dockerhub_password = "${{ secrets.DOCKER_PAT }}"
          EOF

          echo ".env.terraform=$(cat ${{ runner.workspace }}/terraform/tfvars/.env.terraform)"

          # find . -type f -name "*.tf" -exec sed -i 's|\${{ runner.workspace }}/terraform/k8s|\${{ runner.workspace }}/k8s|g' {} +
          terraform -chdir=$TERRAFORM_DIR plan -target=module.resources -var-file=${{ runner.workspace }}/terraform/tfvars/.env.terraform -out=tfplan

